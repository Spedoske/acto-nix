{
  stdenv,
  python311Packages,
  ...
}: with python311Packages; buildPythonPackage {
  pname = "acto";
  version = "0.0.1";
  src = builtins.fetchGit {
    url = "git@github.com:xlab-uiuc/acto.git";
    ref = "main";
    rev = "7cf0a84158e0c4f10cbfbc5537a4a98b8504904f";
  };

  doCheck = false;

  propagatedBuildInputs = [deepdiff exrex jsonschema jsonpatch pandas (import ./kubernetes.nix {python311Packages=python311Packages;})];

  preBuild = ''
      cat > setup.py << EOF
from setuptools import setup, find_packages

with open('requirements.txt') as f:
    install_requires = f.read().splitlines()
print(find_packages())
setup(
  name='acto',
  version='0.0.1',
  install_requires=install_requires,
  packages=find_packages()+["data"],
  scripts=[
    'acto_main.py'
  ],
)
EOF
echo 'ZGlmZiAtLWdpdCBhL2FjdG8vY2hlY2tlci9jaGVja2VyLnB5IGIvYWN0by9jaGVja2VyL2NoZWNrZXIucHkKaW5kZXggMGE0ZTY4NC4uZjA4NjE4YiAxMDA2NDQKLS0tIGEvYWN0by9jaGVja2VyL2NoZWNrZXIucHkKKysrIGIvYWN0by9jaGVja2VyL2NoZWNrZXIucHkKQEAgLTEsNSArMSw1IEBACiBpbXBvcnQgY29weQotaW1wb3J0IGltcG9ydGxpYgoraW1wb3J0IGltcG9ydGxpYi51dGlsCiBpbXBvcnQgbG9nZ2luZwogaW1wb3J0IG9wZXJhdG9yCiBpbXBvcnQgb3MKQEAgLTExMDQsNyArMTEwNCw3IEBAIGlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAKICAgICAgICAgICAgIGlucHV0X21vZGVsID0gSW5wdXRNb2RlbChjb250ZXh0WydjcmQnXVsnYm9keSddLCBbXSwgY29uZmlnLmV4YW1wbGVfZGlyLCAxLCAxLCBbXSkKIAotICAgICAgICAgICAgbW9kdWxlID0gaW1wb3J0bGliLmltcG9ydF9tb2R1bGUoY29uZmlnLms4c19maWVsZHMpCisgICAgICAgICAgICBtb2R1bGUgPSBpbXBvcnRsaWIudXRpbC5zcGVjX2Zyb21fZmlsZV9sb2NhdGlvbihjb25maWcuazhzX2ZpZWxkcywgb3MucGF0aC5qb2luKGFyZ3MuY29uZmlnLGNvbmZpZy5rOHNfZmllbGRzWzU6XS5yZXBsYWNlKCcuJywgb3MucGF0aC5zZXApKSkKIAogICAgICAgICAgICAgZm9yIGs4c19maWVsZCBpbiBtb2R1bGUuV0hJVEVCT1g6CiAgICAgICAgICAgICAgICAgaW5wdXRfbW9kZWwuYXBwbHlfazhzX3NjaGVtYShrOHNfZmllbGQpCmRpZmYgLS1naXQgYS9hY3RvL2lucHV0L2lucHV0LnB5IGIvYWN0by9pbnB1dC9pbnB1dC5weQppbmRleCBiY2M2MzRmLi5mMjQ0YzkxIDEwMDY0NAotLS0gYS9hY3RvL2lucHV0L2lucHV0LnB5CisrKyBiL2FjdG8vaW5wdXQvaW5wdXQucHkKQEAgLTg5Miw3ICs4OTIsNyBAQCBjbGFzcyBEZXRlcm1pbmlzdGljSW5wdXRNb2RlbChJbnB1dE1vZGVsKToKIAogaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgICBpbXBvcnQgYXJncGFyc2UKLSAgICBpbXBvcnQgaW1wb3J0bGliCisgICAgaW1wb3J0IGltcG9ydGxpYi51dGlsCiAgICAgaW1wb3J0IG9zCiAgICAgaW1wb3J0IHRpbWUKICAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQpAQCAtOTIzLDEzICs5MjMsMTMgQEAgaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgICBpbnB1dF9tb2RlbDogSW5wdXRNb2RlbCA9IElucHV0TW9kZWwoY29udGV4dFsnY3JkJ11bJ2JvZHknXSwgW10sIGNvbmZpZy5leGFtcGxlX2RpciwgMSwgMSwgW10pCiAgICAgaWYgYXJncy5ibGFja2JveDoKICAgICAgICAgcHJ1bmVkX2xpc3QgPSBbXQotICAgICAgICBtb2R1bGUgPSBpbXBvcnRsaWIuaW1wb3J0X21vZHVsZShjb25maWcuYmxhY2tib3hfY3VzdG9tX2ZpZWxkcykKKyAgICAgICAgbW9kdWxlID0gaW1wb3J0bGliLnV0aWwuc3BlY19mcm9tX2ZpbGVfbG9jYXRpb24oY29uZmlnLmJsYWNrYm94X2N1c3RvbV9maWVsZHMsIG9zLnBhdGguam9pbihhcmdzLmNvbmZpZyxjb25maWcuYmxhY2tib3hfY3VzdG9tX2ZpZWxkc1s1Ol0ucmVwbGFjZSgnLicsIG9zLnBhdGguc2VwKSkpCiAgICAgICAgIGZvciBjdXN0b21fZmllbGQgaW4gbW9kdWxlLmN1c3RvbV9maWVsZHM6CiAgICAgICAgICAgICBwcnVuZWRfbGlzdC5hcHBlbmQoY3VzdG9tX2ZpZWxkLnBhdGgpCiAgICAgICAgICAgICBpbnB1dF9tb2RlbC5hcHBseV9jdXN0b21fZmllbGQoY3VzdG9tX2ZpZWxkKQogICAgIGVsc2U6CiAgICAgICAgIHBydW5lZF9saXN0ID0gW10KLSAgICAgICAgbW9kdWxlID0gaW1wb3J0bGliLmltcG9ydF9tb2R1bGUoY29uZmlnLmN1c3RvbV9maWVsZHMpCisgICAgICAgIG1vZHVsZSA9IGltcG9ydGxpYi51dGlsLnNwZWNfZnJvbV9maWxlX2xvY2F0aW9uKGNvbmZpZy5jdXN0b21fZmllbGRzLCBvcy5wYXRoLmpvaW4oYXJncy5jb25maWcsY29uZmlnLmN1c3RvbV9maWVsZHNbNTpdLnJlcGxhY2UoJy4nLCBvcy5wYXRoLnNlcCkpKQogICAgICAgICBmb3IgY3VzdG9tX2ZpZWxkIGluIG1vZHVsZS5jdXN0b21fZmllbGRzOgogICAgICAgICAgICAgcHJ1bmVkX2xpc3QuYXBwZW5kKGN1c3RvbV9maWVsZC5wYXRoKQogICAgICAgICAgICAgaW5wdXRfbW9kZWwuYXBwbHlfY3VzdG9tX2ZpZWxkKGN1c3RvbV9maWVsZCkKCg==' | base64 -d | patch -p1
cat acto_main.py
'';

   postInstall = ''
    mv -v $out/bin/acto_main.py $out/bin/acto
    sed -i '1i#!/usr/bin/env python3' $out/bin/acto
  '';

}
